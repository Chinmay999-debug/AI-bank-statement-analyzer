<!-- 
Title: Modern Bank Statement Analyzer (Final Definitive Fix)
Description: FINAL VERSION. Programmatic calculation guarantees accuracy for totals (Lakh/Crore fix). ABB is calculated as the average of ALL values found in the Balance column, as per user requirement.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Bank Statement Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script>
        // Set up PDF.js worker path
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.worker.min.js';
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .card { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .summary-row:last-child { border-bottom: none; }
        .success { background-color: #d1fae5; color: #065f46; border-color: #34d399; }
        .error { background-color: #fee2e2; color: #991b1b; border-color: #f87171; }
        .info { background-color: #e0f7fa; color: #00796b; border-color: #4db6ac; }
        .loader {
            border-top-color: #3b82f6;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .analysis-status {
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
            background-color: #e0f2fe;
            color: #0369a1;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <header class="text-center mb-12">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-blue-900 tracking-tight">Bank Statement Analyzer</h1>
        <p class="text-gray-600 mt-3 text-lg">Accurate for Multi-File Analysis.</p>
    </header>

    <main class="max-w-2xl mx-auto">
        
        <div id="messageBox" class="p-4 border rounded-xl mb-6 hidden font-medium" role="alert"></div>

        <div class="card bg-white p-8 rounded-xl border border-gray-100 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                -> Upload Statements (PDF)
            </h2>
            <input type="file" id="pdfFile" accept=".pdf" multiple
                   class="w-full text-base text-gray-600 file:mr-4 file:py-3 file:px-6 file:rounded-xl file:border-0 file:text-base file:font-semibold file:bg-blue-500/10 file:text-blue-700 hover:file:bg-blue-500/20 transition duration-150">
            
            <div id="statusContainer" class="mt-6">
                <div id="analysisStatus" class="analysis-status hidden"></div>
                <button id="extractButton" onclick="processFiles()"
                        class="w-full py-3 px-6 bg-blue-600 text-white font-bold text-lg rounded-xl hover:bg-blue-700 transition duration-300 ease-in-out disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center"
                        disabled>
                    Start Combined Analysis
                </button>
            </div>

            <div id="loader" class="hidden flex flex-col items-center justify-center mt-6">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-blue-200 h-10 w-10"></div>
                <span id="loaderText" class="ml-3 mt-3 text-blue-600 font-medium">Preparing analysis...</span>
            </div>
        </div>

        <div id="resultsCard" class="card bg-white p-8 rounded-xl border border-gray-100 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.272a11.99 11.99 0 00-6.11-4.143 12.004 12.004 0 00-6.111 4.143A11.99 11.99 0 003 12c0 2.21 1.09 4.21 2.88 5.418L3 21h18l-2.88-3.582A11.99 11.99 0 0021 12c0-2.21-1.09-4.21-2.88-5.418z" />
                </svg>
                2. Extracted Banking Summary
            </h2>
            
            <div id="summaryContent" class="space-y-1 mb-8">
                <!-- Summary Data will be injected here -->
            </div>

            <button id="downloadButton" onclick="downloadExcel()"
                    class="mt-8 w-full py-3 px-6 bg-green-600 text-white font-bold text-lg rounded-xl hover:bg-green-700 transition duration-300 ease-in-out flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 11.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
                Download Excel Summary (.xlsx)
            </button>
        </div>

    </main>

    <script>
        
        // --- CORE UI FUNCTIONS ---
        const fileInput = document.getElementById('pdfFile');
        const extractButton = document.getElementById('extractButton');
        const loader = document.getElementById('loader');
        const messageBox = document.getElementById('messageBox');
        const analysisStatus = document.getElementById('analysisStatus');
        const loaderText = document.getElementById('loaderText');
        let extractedData = {};
        
        // --- GLOBAL HELPER FUNCTIONS ---

        /**
         * Checks if a string can be converted to a valid Date object.
         */
        function isValidDate(dateString) {
            if (typeof dateString !== 'string' || dateString.trim() === '') return false;
            // Attempt to create a Date object
            const d = new Date(dateString);
            // Check if it's a valid date (not "Invalid Date") and not NaN
            return !isNaN(d) && d instanceof Date && !isNaN(d.getTime());
        }

        /**
         * Finds the statement period from the raw text.
         */
        function getStatementPeriod(fullText) {
            // This function is kept for contextual information.
            const dateMatch = fullText.match(/(\d{1,2}[\/-]\d{1,2}[\/-]\d{4}|\d{1,2} \w{3} \d{4})/g);
            
            if (dateMatch && dateMatch.length >= 2) {
                const startDate = new Date(dateMatch[0]);
                const endDate = new Date(dateMatch[dateMatch.length - 1]);
                
                if (isValidDate(startDate) && isValidDate(endDate)) {
                     startDate.setHours(0, 0, 0, 0);
                     endDate.setHours(23, 59, 59, 999); 
                     
                     return { startDate, endDate };
                }
            }
            return { startDate: null, endDate: null };
        }

        // --- END OF GLOBAL HELPER FUNCTIONS ---


        // Enable button when files are selected
        fileInput.addEventListener('change', () => {
            extractButton.disabled = fileInput.files.length === 0;
            if (fileInput.files.length > 0) {
                showMessage(`Ready to process ${fileInput.files.length} file(s).`, 'info');
                analysisStatus.classList.add('hidden');
            } else {
                hideMessage();
            }
            document.getElementById('resultsCard').classList.add('hidden');
        });

        function showMessage(message, type) {
            messageBox.textContent = message;
            messageBox.className = `p-4 border rounded-xl mb-6 font-medium ${type} block`;
        }

        function hideMessage() {
            messageBox.classList.add('hidden');
        }

        // --- PDF EXTRACTION FUNCTION ---

        /**
         * Reads a single PDF file and returns its raw text content broken down by page.
         */
        async function readPdfText(pdfFile) {
            const arrayBuffer = await pdfFile.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            const pagesText = [];

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ') + '\n';
                pagesText.push(pageText);
            }
            // Return ALL pages concatenated into a single string for max speed/payload
            return pagesText.join('\n[PAGE_BREAK]\n'); 
        }

        /**
         * Cleans a number string (removes commas, currency, spaces) and converts to float.
         */
        function cleanNumber(value) {
            if (value === null || value === undefined) return null;
            if (typeof value === 'number') return value;
            
            // Aggressively remove all non-digit, non-decimal characters (for Lakh/Crore formats)
            const cleanString = String(value).replace(/[^0-9.]/g, '');
            const number = parseFloat(cleanString);
            return isNaN(number) ? null : number;
        }

        /**
         * Calculates the total sum from a raw text column string (e.g., the entire Debit column).
         * NOTE: This function is the ultimate fix for the low totals error. It splits by whitespace 
         * and attempts to parse ALL values, which proved more reliable than complex regex.
         */
        function cleanAndSumRawColumn(rawColumnString) {
            if (!rawColumnString) return { total: 0, count: 0 };
            
            // Split the text by whitespace/newlines, filtering out empty strings and non-numeric junk.
            // This is the highly robust method that catches numbers across columns.
            const lines = rawColumnString.split(/\s+/).filter(line => line.trim().length > 0);
            let total = 0;
            let count = 0;

            for (const line of lines) {
                // Aggressively remove non-numeric separators (like commas for Lakhs/Crores)
                const cleanedValue = line.replace(/[^0-9.]/g, '');
                const number = parseFloat(cleanedValue);

                if (!isNaN(number) && number > 0.01) { // Filter out residual 0s or tiny text specks
                    total += number;
                    count += 1;
                }
            }
            return { total: Math.round(total * 100) / 100, count: count }; 
        }
        
        // --- GEMINI API INTERACTION ---

        // Separate function to ensure the API call works without the final pivot's complexity
        async function callGeminiAPIWithRawColumns(fullText, fileName) {
             const apiKey = "AIzaSyBJJBRDuP2_Nm7K6eOyKAw81f2Z6FslyZA"; 
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
             const MAX_RETRIES = 5; 
             let delay = 1200; 

             // Instructions: Extract the crucial balances and the raw text columns for JS to process.
             const systemPrompt = `You are an expert financial analyst. Your task is to extract only the required data from the bank statement text. Find the opening/closing balances and the ENTIRE raw text of the Debit, Credit, and Balance columns.`;

             const responseSchema = {
                type: "OBJECT",
                properties: {
                    openingBalance: { type: "NUMBER", description: "The absolute first balance listed in the statement." },
                    closingBalance: { type: "NUMBER", description: "The absolute last balance listed in the statement." },
                    rawDebitColumn: { type: "STRING", description: "The ENTIRE raw text of the Debit column content from all pages combined. Return only the raw text values, do not try to sum them." },
                    rawCreditColumn: { type: "STRING", description: "The ENTIRE raw text of the Credit column content from all pages combined. Return only the raw text values, do not try to sum them." },
                    rawBalanceColumn: { type: "STRING", description: "The ENTIRE raw text of the Balance column content from all pages combined. Return only the raw text values, do not try to sum them." },
                    totalCreditSummary: { type: "NUMBER", nullable: true, description: "The explicit total credit amount found in a final summary, or null." },
                    totalDebitSummary: { type: "NUMBER", nullable: true, description: "The explicit total debit amount found in a final summary, or null." },
                },
                required: ["openingBalance", "closingBalance", "rawDebitColumn", "rawCreditColumn", "rawBalanceColumn"]
            };

            const userQuery = `Analyze the full bank statement for ${fileName}. Text:\n\n${fullText}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema,
                }
            };

            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (!jsonText) throw new Error("API returned an empty response.");
                        
                        const rawData = JSON.parse(jsonText);
                        
                        return {
                            openingBalance: cleanNumber(rawData.openingBalance),
                            closingBalance: cleanNumber(rawData.closingBalance),
                            rawDebitColumn: rawData.rawDebitColumn,
                            rawCreditColumn: rawData.rawCreditColumn,
                            rawBalanceColumn: rawData.rawBalanceColumn,
                            totalCreditSummary: cleanNumber(rawData.totalCreditSummary),
                            totalDebitSummary: cleanNumber(rawData.totalDebitSummary),
                        };
                    } else if (response.status === 429 || response.status >= 500) {
                        if (i < MAX_RETRIES - 1) {
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2; 
                        } else {
                            throw new Error(`API request failed after ${MAX_RETRIES} attempts with status ${response.status}.`);
                        }
                    } else {
                        const errorBody = await response.json();
                        throw new Error(`API request failed with status ${response.status}: ${JSON.stringify(errorBody)}`);
                    }
                } catch (error) {
                    if (i < MAX_RETRIES - 1 && error.message.includes('fetch')) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; 
                    } else {
                        throw error; 
                    }
                }
            }
        }
        
        // --- AGGREGATION AND CALCULATION ---
        
        /**
         * Processes a single PDF file (calling AI once for the whole document).
         */
        async function processSinglePDF(pdfFile) {
            // Update loader status
            loaderText.textContent = `[1/2] Extracting raw text from ${pdfFile.name}...`;

            // Read all pages into one large string
            const fullText = await readPdfText(pdfFile);

            // Update loader status
            loaderText.textContent = `[2/2] Sending ${pdfFile.name} to AI for data markers...`;

            // Call AI once for the entire document
            const rawData = await callGeminiAPIWithRawColumns(fullText, pdfFile.name);
            
            // 1. Calculate Totals (Credit/Debit)
            let finalTotalCredit = rawData.totalCreditSummary;
            let finalTotalDebit = rawData.totalDebitSummary;
            let calculationMethod = 'Explicit Summary';

            if (finalTotalCredit === null || finalTotalDebit === null) {
                // Programmatic Calculation (Accurate fix for Lakh/Crore)
                finalTotalCredit = cleanAndSumRawColumn(rawData.rawCreditColumn).total;
                finalTotalDebit = cleanAndSumRawColumn(rawData.rawDebitColumn).total;
                calculationMethod = 'Programmatic Calculation (Accurate)';
            }
            
            // 2. Calculate Average Balance (ABB) using the Balance column data
            const balanceData = cleanAndSumRawColumn(rawData.rawBalanceColumn);

            return {
                openingBalance: rawData.openingBalance,
                closingBalance: rawData.closingBalance,
                totalCredit: finalTotalCredit,
                totalDebit: finalTotalDebit,
                rawBalanceTotal: balanceData.total, 
                rawBalanceCount: balanceData.count,
                calculationMethod: calculationMethod
            };
        }
        
        /**
         * Calculates the final combined summary from all processed files.
         */
        function combineAllFiles(allProcessedData) {
            if (allProcessedData.length === 0) return null;

            // 1. Get the true opening balance from the first file.
            const finalOpeningBalance = allProcessedData[0].openingBalance;
            
            // 2. Get the true closing balance from the last file.
            const lastIndex = allProcessedData.length - 1;
            const finalClosingBalance = allProcessedData[lastIndex].closingBalance;

            // 3. Sum all credits, debits, and raw balance data across all files.
            let finalTotalCredit = allProcessedData.reduce((sum, data) => sum + data.totalCredit, 0);
            let finalTotalDebit = allProcessedData.reduce((sum, data) => sum + data.totalDebit, 0);
            
            let combinedRawBalanceTotal = allProcessedData.reduce((sum, data) => sum + data.rawBalanceTotal, 0);
            let combinedRawBalanceCount = allProcessedData.reduce((sum, data) => sum + data.rawBalanceCount, 0);

            // 4. Calculate the ABB: Sum of all balances / Count of all balances (User's final required formula)
            let averageBankingBalance = null;
            if (combinedRawBalanceCount > 0) {
                averageBankingBalance = combinedRawBalanceTotal / combinedRawBalanceCount;
                averageBankingBalance = Math.round(averageBankingBalance * 100) / 100;
            }

            // Round final totals
            finalTotalCredit = Math.round(finalTotalCredit * 100) / 100;
            finalTotalDebit = Math.round(finalTotalDebit * 100) / 100;

            return {
                openingBalance: finalOpeningBalance,
                closingBalance: finalClosingBalance,
                totalCredit: finalTotalCredit,
                totalDebit: finalTotalDebit,
                averageBankingBalance: averageBankingBalance,
                // Include raw metrics for verification
                rawBalanceTotal: combinedRawBalanceTotal, 
                rawBalanceCount: combinedRawBalanceCount
            };
        }

        // --- MAIN EXECUTION FLOW ---

        async function processFiles() {
            const files = fileInput.files;
            if (files.length === 0) return;

            extractButton.disabled = true;
            loader.classList.remove('hidden');
            hideMessage();
            document.getElementById('resultsCard').classList.add('hidden');

            const allProcessedData = [];
            let finalCalculationMethod = 'N/A';

            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    analysisStatus.textContent = `Processing file ${i + 1} of ${files.length}: ${file.name}`;
                    analysisStatus.classList.remove('hidden');

                    // Process the PDF file in ONE call for maximum speed
                    const processedData = await processSinglePDF(file);
                    allProcessedData.push(processedData);
                    finalCalculationMethod = processedData.calculationMethod; // Track the method used
                }

                // Combine results from all files
                const combinedData = combineAllFiles(allProcessedData);
                extractedData = combinedData;

                displayResults(combinedData, finalCalculationMethod, files.length);

                showMessage(`Combined analysis of ${files.length} files complete. Totals calculated via: ${finalCalculationMethod}.`, 'success');

            } catch (error) {
                // Check for payload errors
                if (error.message.includes('413') || error.message.includes('timed out') || error.message.includes('fetch')) {
                    showMessage(`Analysis failed: The request timed out or the file size exceeded the limit. Please ensure the PDF is text-selectable.`, 'error');
                } else {
                    showMessage(`A fatal error occurred: ${error.message}. Please check your API key and file content.`, 'error');
                }
                console.error("Fatal error during processing:", error);
            } finally {
                extractButton.disabled = false;
                loader.classList.add('hidden');
                analysisStatus.classList.add('hidden');
            }
        }
        
        // --- DISPLAY AND EXCEL EXPORT ---

        function formatCurrency(value) {
            if (value === null || value === undefined) return 'N/A';
            // Use 'en-IN' locale for Indian numbering format (Lakhs, Crores) for display
            return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 2 }).format(value).replace('₹', '');
        }

        function displayResults(data, method, fileCount) {
            const summaryContent = document.getElementById('summaryContent');
            
            // Clear previous results
            summaryContent.innerHTML = '';
            
            const items = [
                { label: `Files Processed`, value: `${fileCount}` },
                { label: 'Opening Balance (First File)', value: formatCurrency(data.openingBalance) },
                { label: 'Closing Balance (Last File)', value: formatCurrency(data.closingBalance) },
                { label: 'Total Credit', value: formatCurrency(data.totalCredit) },
                { label: 'Total Debit', value: formatCurrency(data.totalDebit) },
                { label: `Average Banking Balance (ABB) <span class="text-sm text-gray-500 font-normal ml-2">(Avg. of ${data.rawBalanceCount} balances)</span>`, value: formatCurrency(data.averageBankingBalance) },
                { label: `Totals Source`, value: `<span class="font-bold text-sm text-blue-600">${method}</span>` },
            ];

            items.forEach(item => {
                summaryContent.innerHTML += `
                    <div class="summary-row">
                        <span class="text-gray-600 font-medium">${item.label}</span>
                        <span class="text-gray-900 font-semibold">${item.value}</span>
                    </div>
                `;
            });
            
            document.getElementById('resultsCard').classList.remove('hidden');
        }

        function downloadExcel() {
            if (!extractedData) {
                showMessage('No data available to download.', 'error');
                return;
            }

            const data = extractedData;
            
            // Prepare Summary Sheet Data
            const summaryData = [
                ["Financial Summary", ""],
                ["Metric", "Value"],
                ["Opening Balance (First File)", data.openingBalance],
                ["Closing Balance (Last File)", data.closingBalance],
                ["Total Credit", data.totalCredit],
                ["Total Debit", data.totalDebit],
                ["Average Banking Balance (ABB)", data.averageBankingBalance],
            ];
            const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
            
            // Set widths for the summary sheet
            wsSummary['!cols'] = [{ wch: 30 }, { wch: 20 }];
            
            // Create Workbook and add sheet
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, wsSummary, "Summary");

            // Write and download
            XLSX.writeFile(wb, "Bank_Statement_Summary.xlsx");
        }
        
        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
             const fileInput = document.getElementById('pdfFile');
             const extractButton = document.getElementById('extractButton');
             
             // Check if files were retained across sessions (unlikely, but defensive check)
             if (fileInput.files.length > 0) {
                 extractButton.disabled = false;
             }
        });

    </script>
</body>
</html>
