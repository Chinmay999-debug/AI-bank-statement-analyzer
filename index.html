<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Bank Statement Extractor</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load PDF.js for PDF reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';</script>
    <!-- Load SheetJS (XLSX) for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white p-6 sm:p-10 rounded-xl shadow-2xl">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-indigo-700 mb-6">
            Smart Bank Statement Analyzer
        </h1>
        <p class="text-center text-gray-500 mb-8">
            Upload your PDF bank statement to instantly extract key financial metrics using AI and export to Excel.
        </p>

        <!-- Notification Message Box -->
        <div id="message-box" class="hidden mb-6 p-4 rounded-lg font-medium transition-all duration-300"></div>

        <!-- File Upload Area -->
        <div class="border-2 border-dashed border-indigo-300 rounded-xl p-8 text-center bg-indigo-50/50 hover:bg-indigo-100/50 transition duration-300 shadow-inner">
            <input type="file" id="pdf-upload" accept="application/pdf" class="hidden" onchange="document.getElementById('file-name').textContent = this.files[0].name">
            <label for="pdf-upload" class="cursor-pointer inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-full shadow-lg text-white bg-indigo-600 hover:bg-indigo-700 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                Upload Bank Statement PDF
            </label>
            <p id="file-name" class="mt-4 text-sm text-gray-600 truncate">No file chosen</p>
        </div>

        <div class="mt-8 flex justify-center">
             <button onclick="processFile()" class="w-full sm:w-auto px-8 py-3 border border-transparent text-base font-medium rounded-xl shadow-sm text-white bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-300 transform hover:scale-[1.02]">
                Start Extraction
            </button>
        </div>

        <!-- Loader -->
        <div id="loader" class="hidden text-center mt-8">
            <div class="animate-spin inline-block w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full" role="status"></div>
            <p class="mt-2 text-indigo-600 font-semibold">Analyzing PDF with Gemini...</p>
        </div>

        <!-- Results Area -->
        <div id="result" class="mt-10">
            <!-- Results will be displayed here -->
        </div>
        
        <!-- Export Button -->
        <div class="mt-8 text-center">
            <button id="export-btn" onclick="exportToExcel(extractedData)" class="hidden w-full sm:w-auto px-8 py-3 border-2 border-green-500 text-base font-medium rounded-xl text-green-700 bg-white hover:bg-green-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-300 transform hover:scale-105">
                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                Download Excel Summary (.xlsx)
            </button>
        </div>

    </div>

    <script>
        let extractedData = null; // Global variable to hold the final data for export

        // Utility function for exponential backoff retry logic
        async function retryFetch(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429 && response.status < 500) {
                        return response; // Success or non-retryable error
                    }
                    if (i === maxRetries - 1) {
                        throw new Error("Maximum retries exceeded");
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    console.log(`Rate limit exceeded (429/5xx). Retrying in ${delay.toFixed(0)}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    console.error(`Fetch attempt failed. Retrying in ${delay.toFixed(0)}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        /**
         * Reads all text content from a PDF file.
         */
        async function readPdfText(pdfFile) {
            const fileReader = new FileReader();
            fileReader.readAsArrayBuffer(pdfFile);

            return new Promise((resolve, reject) => {
                fileReader.onload = async () => {
                    const typedarray = new Uint8Array(fileReader.result);
                    try {
                        const pdf = await pdfjsLib.getDocument({ data: typedarray }).promise;
                        let fullText = '';
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            fullText += textContent.items.map(s => s.str).join(' ') + '\n\n';
                        }
                        resolve(fullText);
                    } catch (error) {
                        reject(new Error(`Failed to read PDF: ${error.message}`));
                    }
                };
                fileReader.onerror = () => reject(new Error("Error reading file."));
            });
        }

        /**
         * Displays status messages to the user.
         */
        function showMessage(message, type = 'info') {
            const box = document.getElementById('message-box');
            box.textContent = message;
            box.className = 'mb-6 p-4 rounded-lg font-medium transition-all duration-300';
            box.classList.remove('hidden');

            switch (type) {
                case 'success':
                    box.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-300');
                    break;
                case 'error':
                    box.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-300');
                    break;
                case 'info':
                default:
                    box.classList.add('bg-blue-100', 'text-blue-800', 'border', 'border-blue-300');
                    break;
            }
        }

        /**
         * Formats JSON keys for display (e.g., 'openingBalance' -> 'Opening Balance').
         */
        function formatLabel(key) {
            let label = key.replace(/([A-Z])/g, ' $1');
            label = label.charAt(0).toUpperCase() + label.slice(1);
            return label.includes('Average') ? 'Average Banking Balance (ABB)' : label;
        }

        /**
         * Formats numerical values for display (e.g., adds commas).
         */
        function formatValue(value, key) {
            if (value === null || value === undefined) {
                return 'N/A';
            }
            if (key === 'averageBalance' && value === 0) {
                 return '0.00';
            }
            // Use Intl.NumberFormat for currency display (assuming INR or just generic number format)
            try {
                return new Intl.NumberFormat('en-IN', {
                    style: 'decimal',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(value);
            } catch (e) {
                return value.toString(); // Fallback
            }
        }


        /**
         * Calls the Gemini API with the PDF text to extract financial data.
         */
        async function callGeminiAPI(pdfText) {
            // --- IMPORTANT ---
            // When you host this file yourself, you MUST provide your own API key.
            // 1. Get your key from Google AI Studio (https://aistudio.google.com/app/apikey)
            // 2. Paste your key here:
            const apiKey = "AIzaSyBJJBRDuP2_Nm7K6eOyKAw81f2Z6FslyZA"; // <--- YOUR API KEY IS NOW HERE
            //
            // DO NOT SHARE THIS FILE PUBLICLY WITH YOUR KEY IN IT.
            // -----------------

            if (apiKey === "YOUR_PASTED_API_KEY_HERE" || apiKey === "") {
                showMessage("API Key is missing. Please add your Google AI Studio API key to the script.", "error");
                throw new Error("API Key is missing.");
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const systemPrompt = `You are an expert financial analyst. Your task is to extract key figures from a bank statement's raw text. The text is from a PDF and may have formatting issues or OCR errors.
Find the most likely values for the requested fields. Parse numbers correctly, removing currency symbols (like $, £, €) and commas.

The output MUST be a valid JSON object matching the following structure and data types:
{
  "openingBalance": number,
  "closingBalance": number,
  "totalCredit": number,
  "totalDebit": number,
  "averageBalance": number | null
}

--- Extraction Logic (Critical) ---
1. **Opening Balance:** Find the first recorded balance figure in the transaction list. This may be explicitly labeled "Balance B/F" or be the 'Balance' field associated with the earliest date. If the very first transaction is a deposit and the subsequent balance is non-zero, the starting balance (Opening Balance) is 0.
2. **Closing Balance:** Find the last recorded 'Balance' value in the entire transaction list.
3. **Total Credit/Debit:**
    * **Attempt 1 (Preferred):** Look for a specific 'STATEMENT SUMMARY', 'SUMMARY', or 'TOTALS' section that explicitly lists "Total Credit/Deposit" and "Total Debit/Withdrawal" figures.
    * **Attempt 2 (Fallback):** If no explicit summary is found, you MUST calculate the totals by summing all the values found under the 'Deposit Amt.' (Credit) column and the 'Withdrawal Amt.' (Debit) column in the transaction list across all pages.
4. **Average Balance (ABB):** Try to find a figure explicitly labeled as "Average Balance," "Average Monthly Balance," or "ABB." If no such explicit figure is found in the text, return null. DO NOT calculate the daily average yourself, as that requires complex date logic.
`;

            const userQuery = `Extract the key financial metrics from the following bank statement text. The data should be formatted exactly as JSON: \n\n--- BANK STATEMENT TEXT ---\n${pdfText}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "openingBalance": { "type": "NUMBER" },
                            "closingBalance": { "type": "NUMBER" },
                            "totalCredit": { "type": "NUMBER" },
                            "totalDebit": { "type": "NUMBER" },
                            "averageBalance": { "type": "NUMBER", "nullable": true }
                        },
                        "propertyOrdering": ["openingBalance", "closingBalance", "totalCredit", "totalDebit", "averageBalance"]
                    }
                }
            };

            const response = await retryFetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.json();
                console.error("API Error Response:", errorBody);
                throw new Error(`API request failed with status ${response.status}: ${JSON.stringify(errorBody)}`);
            }

            const result = await response.json();
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (!jsonText) {
                throw new Error("AI returned an empty response.");
            }

            try {
                return JSON.parse(jsonText);
            } catch (e) {
                console.error("Failed to parse JSON:", jsonText);
                throw new Error("AI returned invalid JSON format.");
            }
        }

        /**
         * Converts the extracted data object into an Excel (XLSX) file.
         */
        function exportToExcel(data) {
            if (!data) {
                showMessage('No data to export.', 'error');
                return;
            }

            // Prepare worksheet data
            const wsData = [
                ["Metric", "Value"],
                ["Opening Balance", data.openingBalance],
                ["Closing Balance", data.closingBalance],
                ["Total Credit", data.totalCredit],
                ["Total Debit", data.totalDebit],
                // Display calculated ABB clearly
                ["Average Banking Balance (ABB)", data.averageBalance === null ? 'N/A (Calculated as simple average)' : data.averageBalance]
            ];

            // Create worksheet and workbook
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Financial Summary");

            // Write and download the file
            XLSX.writeFile(wb, "Bank_Statement_Summary.xlsx");
            showMessage('Summary exported to Bank_Statement_Summary.xlsx', 'success');
        }

        /**
         * Main function to handle file processing and API call.
         */
        async function processFile(event) {
            const fileInput = document.getElementById('pdf-upload');
            const pdfFile = fileInput.files[0];
            const loader = document.getElementById('loader');
            const resultDiv = document.getElementById('result');
            const exportBtn = document.getElementById('export-btn');

            if (!pdfFile) {
                showMessage('Please select a PDF file.', 'error');
                return;
            }

            // Clear previous results
            resultDiv.innerHTML = '';
            exportBtn.classList.add('hidden');
            loader.classList.remove('hidden');

            try {
                const pdfText = await readPdfText(pdfFile);
                showMessage('PDF text extracted. Asking AI to analyze...', 'info');
                
                const data = await callGeminiAPI(pdfText);

                // --- FALLBACK LOGIC FOR AVERAGE BALANCE (ABB) ---
                // If AI returns null for averageBalance (meaning it wasn't explicitly found), calculate it as a simple average.
                if (data.averageBalance === null || data.averageBalance === undefined) {
                    if (data.openingBalance !== null && data.openingBalance !== undefined &&
                        data.closingBalance !== null && data.closingBalance !== undefined) {
                        
                        // Calculate simple average and round to 2 decimal places
                        data.averageBalance = (data.openingBalance + data.closingBalance) / 2;
                        data.averageBalance = Math.round(data.averageBalance * 100) / 100;
                        
                        showMessage('AI analysis complete. (Average Balance calculated as simple average fallback)', 'success');
                    } else {
                        // This case happens if opening/closing are also null
                        showMessage('AI analysis complete. (Average Balance not found and could not be calculated)', 'success');
                    }
                } else {
                     showMessage('AI analysis complete. (Average Balance found in statement)', 'success');
                }
                // --- END OF FALLBACK LOGIC ---

                extractedData = data;
                
                // Display results in a readable table
                resultDiv.innerHTML = `
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-800 border-b pb-2">Extracted Financial Summary</h3>
                        ${Object.entries(data).map(([key, value]) => `
                            <div class="flex justify-between items-center p-3 bg-white rounded-lg shadow-sm">
                                <span class="font-medium text-gray-600">${formatLabel(key)}</span>
                                <span class="font-bold text-lg text-gray-900">${formatValue(value, key)}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                exportBtn.classList.remove('hidden');

            } catch (error) {
                console.error(error);
                showMessage(`Extraction Failed: ${error.message}`, 'error');
            } finally {
                loader.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
